# Ray Kubernetes Operator (experimental)

## File structure of Ray Operator Node Provider
In the autoscaler we implement a new node provider, let autoscaler can integrate with the operator to auto-scale. 
* `BACKEND=<your_backend>` Replace '<your_backend>' with one of: 'aws', 'gcp', 'kubernetes','kubernetes_operator', or 'local'.
* `ray up ray/python/ray/autoscaler/$BACKEND/example-full.yaml` Create or update the cluster.
* `ray down ray/python/ray/autoscaler/$BACKEND/example-full.yaml` Tear down the cluster.
```
└── autoscaler
    ├── _private
    │   ├── kubernetes_operator
    │   │   ├── __init__.py
    │   │   ├── config.py
    │   │   ├── kubectl-rsync.sh
    │   │   ├── node_provider.py
    │   │   └── ray_cluster_constant.py
    │   └── providers.py
    ├── kubernetes
    │   └── example-full.yaml
    └── kubernetes_operator
        ├── __init__.py
        ├── defaults.yaml
        ├── example-full.yaml
        ├── example-ingress.yaml
        └── example-minimal.yaml
```
## File structure of Ray Operator
This directory contains the source code for a Ray operator for Kubernetes.

Some main features of the operator are:
* Management of first-class RayClusters via a custom resource.
* Support for heterogeneous worker types in a single Ray cluster.
* Built-in monitoring via Prometheus.

> ```
> ray/deploy/ray-operator
> ├── api/v1alpha1  // Package v1alpha1 contains API Schema definitions for the ray v1alpha1 API group
> │   ├── groupversion_info.go // contains common metadata about the group-version
> │   ├── raycluster_types.go  // RayCluster field definitions, user should focus
> │   └── zz_generated.deepcopy.go // contains the autogenerated implementation of the aforementioned runtime.Object interface, which marks all of our root types as representing Kinds.
> │
> │── config   // contains Kustomize YAML definitions required to launch our controller on a cluster,hold our CustomResourceDefinitions, RBAC configuration, and WebhookConfigurations.
> │  ├── certmanager
> │  │   ├── certificate.yaml  // The following manifests contain a self-signed issuer CR and a certificate CR.
> │  │   ├── kustomization.yaml
> │  │   └── kustomizeconfig.yaml
> │  │
> │  ├── crd
> │  │   └── bases
> │  │   │   └── ray.io_rayclusters.yaml  // RayCluster CRD yaml file
> │  │   └── patches
> │  │   │   ├── cainjection_in_rayclusters.yaml  // adds a directive for certmanager to inject CA into the CRD
> │  │   │   └── webhook_in_rayclusters.yaml  // enables conversion webhook for CRD
> │  │   │── kustomization.yaml
> │  │   └── kustomizeconfig.yaml
> │  │
> │  ├── default     // contains a Kustomize base for launching the controller in a standard configuration.
> │  │   ├── kustomization.yaml
> │  │   ├── manager_auth_proxy_patch.yaml // inject a sidecar container which is a HTTP proxy for the controller manager, it performs RBAC authorization against the Kubernetes API using SubjectAccessReviews.
> │  │   ├── manager_webhook_patch.yaml    // webhook yaml file
> │  │   └── webhookcainjection_patch.yaml // add annotation to admission webhook config
> │  │
> │  ├── manager      // launch your controllers as pods in the cluster.
> │  │   ├── kustomization.yaml
> │  │   └── manager.yaml     // manager yaml to create controller deployment, user should focus
> │  │
> │  ├── prometheus
> │  │   ├── kustomization.yaml
> │  │   └── monitor.yaml     // Prometheus Monitor Service, user should focus
> │  │
> │  ├── rbac        // permissions required to run your controllers under their own service account.
> │  │   ├── auth_proxy_role.yaml
> │  │   ├── auth_proxy_role_binding.yaml
> │  │   ├── auth_proxy_service.yaml
> │  │   ├── kustomization.yaml
> │  │   ├── leader_election_role.yaml   // permissions to do leader election.
> │  │   ├── leader_election_role_binding.yaml
> │  │   └── role_binding.yaml
> │  │
> │  ├── samples      // sample RayCluster yaml, user should focus
> │  │   ├── ray_v1_raycluster.complete.yaml
> │  │   ├── ray_v1_raycluster.heterogeneous.yaml
> │  │   └── ray_v1_raycluster.mini.yaml
> │  │
> │  └── webhook
> │      ├── kustomization.yaml
> │      ├── kustomizeconfig.yaml
> │      ├── manifests.yaml
> │      └── service.yaml   // webhook-service
> │
> │── controller
> │   ├── common
> │   │   ├── constant.go
> │   │   ├── meta.go
> │   │   ├── pod.go
> │   │   └── service.go
> │   └── raycluster_controller.go
> │
> │── main.go
> └── Makefile
> ```

## Todo list
* Redesign CRD to better support multiple node type feature.
* Add RayCluster status.
* Update the operator node provider logic.
* Support helm chart.
* Easy to use documentation.

